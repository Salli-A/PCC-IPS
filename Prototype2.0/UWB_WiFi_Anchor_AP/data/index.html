<!DOCTYPE HTML><html>
<!-- Rui Santos - Complete project details at https://RandomNerdTutorials.com

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files.
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software. -->
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <style>
    div.location{ font-size: 30px; display: inline; }
    canvas { border: 1px solid black; }
    #station { padding-left: 10px; padding-right: 10px; font-weight: bold; }
    body {
      min-width: 310px;
    	max-width: 800px;
    	height: 400px;
      margin: 0 auto;
    }
    h2 {
      font-family: Arial;
      font-size: 2.5rem;
      text-align: center;
    }
  </style>
</head>
<body onload="drawRoom();">
  <h2>PCC part 2, IPS system</h2>


  <p>
    <div class="location">Target location: </div>
    <div class="location" id="station">No station</div>
    </p>

</body>
<canvas id="canvas" width="692" height="1000"></canvas>

<script>
  // pixel / meter ratio
  //pixelRatio = 1000/3.5; // based on my room: width = (1000/3.5)*3,75
  //9.4x6.85m
  pixelRatio = 1000/9.4; // width = (1000/9.4)*6,5


  /*
  x1 = 0;
  y1 = 3.5/2;
  x2 = 3.75;
  y2 = 0;
  x3 = 3.75;
  y3 = 3.5;
  */

  
  x1 = 0;
  y1 = 2;

  x2 = 6.4;
  y2 = 2;

  x3 = 0;
  y3 = 7.8;
  
  x1 = x1*pixelRatio;
  y1 = y1*pixelRatio;
  x2 = x2*pixelRatio;
  y2 = y2*pixelRatio;
  x3 = x3*pixelRatio;
  y3 = y3*pixelRatio;


function drawRoom(){
  
  const ctx = canvas.getContext("2d");
  
  ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(0, 9.4*pixelRatio);
    ctx.lineTo(3.55*pixelRatio, 9.4*pixelRatio);
    ctx.lineTo(3.55*pixelRatio, 4.45*pixelRatio);
    ctx.lineTo(3.70*pixelRatio, 4.45*pixelRatio);
    ctx.lineTo(3.70*pixelRatio, 6.80*pixelRatio);
    ctx.lineTo(6.50*pixelRatio, 6.80*pixelRatio);
    ctx.lineTo(6.50*pixelRatio, 0);
    ctx.lineTo(0, 0);
  ctx.stroke();

  ctx.fillRect(x1, y1, 20, 20);
  ctx.fillRect(x2-10, y2, 20, 20);
  ctx.fillRect(x3, y3, 20, 20);
  ctx.fillRect(4.5*pixelRatio, 8*pixelRatio, 20, 20);
  ctx.font = "25px serif";
  ctx.fillText(": Anchors", 4.5*pixelRatio+25,8*pixelRatio+16)
  ctx.beginPath();
    ctx.arc(4.5*pixelRatio+10, 8.5*pixelRatio, 10, 0, 2 * Math.PI);
    ctx.fill();
  ctx.fillText(": Tag", 4.5*pixelRatio+25,8.5*pixelRatio+6)
  
  ctx.beginPath();
    ctx.moveTo(0,9.4*pixelRatio);
    ctx.lineTo(1.7*pixelRatio,9.4*pixelRatio);
    ctx.lineTo(1.7*pixelRatio,7.8*pixelRatio);
    ctx.lineTo(0,7.8*pixelRatio);
    ctx.lineTo(0,9.4*pixelRatio);
    ctx.font = "50px serif";
    ctx.fillText("Pulling Station #1", 0 , 8.6*pixelRatio , 1.7*pixelRatio);
  ctx.stroke();

  ctx.beginPath();
    ctx.moveTo(0, 7.8*pixelRatio);
    ctx.lineTo(1.7*pixelRatio, 7.8*pixelRatio);
    ctx.lineTo(1.7*pixelRatio, 6.1*pixelRatio);
    ctx.lineTo(0, 6.1*pixelRatio);
    ctx.moveTo(0, 7.8*pixelRatio);
    ctx.font = "50px serif";
    ctx.fillText("Biking station", 0 , 6.95*pixelRatio , 1.7*pixelRatio);
  ctx.stroke();

  
  ctx.beginPath();
    ctx.moveTo(3.55*pixelRatio, 4.45*pixelRatio);
    ctx.lineTo(2.6*pixelRatio, 4.45*pixelRatio);
    ctx.lineTo(2.6*pixelRatio, 6.55*pixelRatio);
    ctx.lineTo(3.55*pixelRatio, 6.55*pixelRatio);
    ctx.lineTo(3.55*pixelRatio, 4.45*pixelRatio);
    ctx.font = "50px serif";
    ctx.fillText("Running station", 2.6*pixelRatio , 5.5*pixelRatio , 0.95*pixelRatio);
  ctx.stroke();

  
  ctx.beginPath();
    ctx.moveTo(0, 4.45*pixelRatio);
    ctx.lineTo(1.4*pixelRatio, 4.45*pixelRatio);
    ctx.lineTo(1.4*pixelRatio, 5.75*pixelRatio);
    ctx.lineTo(0, 5.75*pixelRatio);
    ctx.lineTo(0, 4.45*pixelRatio);
    ctx.font = "50px serif";
    ctx.fillText("Pulling station #2", 0, 5.1*pixelRatio, 1.4*pixelRatio);
  ctx.stroke();

  
  ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(0, 3.95*pixelRatio);
    ctx.lineTo(4.0*pixelRatio, 3.95*pixelRatio);
    ctx.lineTo(4.0*pixelRatio, 0);
    ctx.lineTo(0, 0);
    ctx.font = "50px serif";
    ctx.fillText("Weights station", 0, 3*pixelRatio, 4.0*pixelRatio);
  ctx.stroke();

  
  ctx.beginPath();
    ctx.moveTo(1.40*pixelRatio, 0);
    ctx.lineTo(1.40*pixelRatio, 1.40*pixelRatio);
    ctx.lineTo(2.8*pixelRatio, 1.40*pixelRatio);
    ctx.lineTo(2.8*pixelRatio, 0);
    ctx.font = "50px serif";
    ctx.fillText("Squat station", 1.40*pixelRatio, 0.7*pixelRatio, 1.40*pixelRatio);
  ctx.stroke();

  
  ctx.beginPath();
    ctx.moveTo(4.0*pixelRatio, 0);
    ctx.lineTo(4.0*pixelRatio, 1.85*pixelRatio);
    ctx.lineTo(6.50*pixelRatio, 1.85*pixelRatio);
    ctx.font = "50px serif";
    ctx.fillText("Stretching station", 4.0*pixelRatio, 0.925*pixelRatio, 2.5*pixelRatio);
  ctx.stroke();
  
  ctx.beginPath();
    ctx.moveTo(3.70*pixelRatio, 4.45*pixelRatio);
    ctx.lineTo(4.68*pixelRatio, 4.45*pixelRatio);
    ctx.lineTo(4.68*pixelRatio, 6.8*pixelRatio);
    ctx.lineTo(3.70*pixelRatio, 6.8*pixelRatio);
    ctx.lineTo(3.70*pixelRatio, 4.45*pixelRatio);
    ctx.font = "50px serif";
    ctx.fillText("Rowing station", 3.70*pixelRatio , 5.5*pixelRatio, 0.98*pixelRatio);
  ctx.stroke();

}

setInterval(function ( ) {
  const canvas = document.getElementById("canvas");

  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      txt_received = this.responseText;
      //console.log(txt_received);
      txt_received = txt_received.split(',');
      r1 = parseFloat(txt_received[0]);
      r2 = parseFloat(txt_received[1]);
      r3 = parseFloat(txt_received[2]);
    }
  };
  xhttp.open("GET", "/distance", true);
  xhttp.send();

  if (canvas.getContext) {
    const ctx = canvas.getContext("2d");
    ctx.clearRect(1, 1, 729, 1000); // clear canvas
    drawRoom();

    r1 = r1*pixelRatio;
    r2 = r2*pixelRatio;
    r3 = r3*pixelRatio;
    
    // create the circles representing the acnhors
    ctx.beginPath();
    ctx.arc(x1, y1, r1, 0, Math.PI * 2, true); // circle
    ctx.moveTo(x2+r2, y2);
    ctx.arc(x2, y2, r2, 0, Math.PI * 2, true); // circle
    ctx.moveTo(x3+r3, y3);
    ctx.arc(x3, y3, r3, 0, Math.PI * 2, true); // circle
    ctx.stroke();

    // draw the lines between the circles
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.lineTo(x3, y3);
    ctx.lineTo(x1, y1);
    ctx.stroke();

    // trilateration
    var A = 2*x2 - 2*x1;
    var B = 2*y2 - 2*y1;
    var C = r1**2 - r2**2 - x1**2 + x2**2 - y1**2 + y2**2;
    var D = 2*x3 - 2*x2;
    var E = 2*y3 - 2*y2;
    var F = r2**2 - r3**2 - x2**2 + x3**2 - y2**2 + y3**2;
    var x = (C*E - F*B) / (E*A - B*D);
    var y = (C*D - A*F) / (B*D - A*E);

    //console.log(x);console.log(y);

    // finding location
    station = document.getElementById('station');

    if(y < 1.4*pixelRatio 
      && x > 1.4*pixelRatio && x < 2.8*pixelRatio){
        station.textContent = "Squat station";
    }

    else if(y < 3.95*pixelRatio
      && x < 4.0*pixelRatio){
        station.textContent = "Weight station";
    }

    else if(y < 1.85*pixelRatio 
      && x > 4.0*pixelRatio && x < 6.5*pixelRatio){
        station.textContent = "Stretching station";
    }

    else if(y > 4.45*pixelRatio && y < 5.75*pixelRatio
      && x < 1.4*pixelRatio){
        station.textContent = "Pulling station #2";
    }
  
    else if(x < 1.7*pixelRatio && 
      y > 7.8*pixelRatio){
        station.textContent = "Pulling station #1";
      }
      
    else if(x < 1.7*pixelRatio 
      && y > 6.1*pixelRatio){
        station.textContent = "Biking station";
    }

    else if(y > 4.45*pixelRatio && y < 6.55*pixelRatio 
      && x > 2.6*pixelRatio && x < 3.55*pixelRatio){
        station.textContent = "Running station";
    }

    else if(y > 4.45*pixelRatio && y < 6.8*pixelRatio 
      && x > 3.7*pixelRatio && x < 4.68*pixelRatio){
        station.textContent = "Rowing station";
    }

    else{
      station.textContent = "No station";
    }

    // plot location
    ctx.beginPath();
    ctx.arc(x, y, 15, 0, 2 * Math.PI);
    ctx.fill();
  }
}, 200 ) ;

</script>


</html>